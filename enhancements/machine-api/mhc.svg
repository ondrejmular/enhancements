<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="773px" preserveAspectRatio="none" style="width:702px;height:773px;" version="1.1" viewBox="0 0 702 773" width="702px" zoomAndPan="magnify"><defs><filter height="300%" id="fr24uo5v3f154" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><ellipse cx="243.5" cy="20" fill="#000000" filter="url(#fr24uo5v3f154)" rx="10" ry="10" style="stroke: none; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fr24uo5v3f154)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="223" x="132" y="50"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="203" x="142" y="71.1387">Machine Health Check controller</text><rect fill="#FEFECE" filter="url(#fr24uo5v3f154)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="195" y="191.9688"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="77" x="205" y="213.1074">Watch MHCs</text><rect fill="#FEFECE" filter="url(#fr24uo5v3f154)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="316" x="85.5" y="245.9375"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="296" x="95.5" y="267.0762">Filter out targets with disabled health-checking</text><rect fill="#FEFECE" filter="url(#fr24uo5v3f154)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="444" x="21.5" y="299.9063"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="424" x="31.5" y="321.0449">Find unhealthy targets: Need remediation or going towards timeout</text><polygon fill="#FEFECE" filter="url(#fr24uo5v3f154)" points="243.5,147.9688,255.5,159.9688,243.5,171.9688,231.5,159.9688,243.5,147.9688" style="stroke: #A80036; stroke-width: 1.5;"/><polygon fill="#FEFECE" filter="url(#fr24uo5v3f154)" points="145.5,353.875,341.5,353.875,353.5,365.875,341.5,377.875,145.5,377.875,133.5,365.875,145.5,353.875" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="196" x="145.5" y="369.6831">unhealthyTargets &gt; maxUnhealthy</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="20" x="353.5" y="363.2808">yes</text><polygon fill="#FEFECE" filter="url(#fr24uo5v3f154)" points="243.5,103.9688,255.5,115.9688,243.5,127.9688,231.5,115.9688,243.5,103.9688" style="stroke: #A80036; stroke-width: 1.5;"/><polygon fill="#FEFECE" filter="url(#fr24uo5v3f154)" points="32,419.3716,455,419.3716,467,431.3716,455,443.3716,32,443.3716,20,431.3716,32,419.3716" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="423" x="32" y="435.1797">API server machine deletion requests for machines that need remediation</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="223" x="467" y="428.7773">requeue with minTime to timeout delay</text><rect fill="#ADD8E6" filter="url(#fr24uo5v3f154)" height="61.9063" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="391" x="48" y="484.7705"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="371" x="58" y="505.9092">The machine owner controller watches deletion timestamp.</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="297" x="58" y="519.8779">Reconciles towards desired number of replicas.</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="314" x="58" y="533.8467">The process to create a new machine/node starts</text><rect fill="#ADD8E6" filter="url(#fr24uo5v3f154)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="334" x="76.5" y="566.6768"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="314" x="86.5" y="587.8154">The machine controller drains the unhealthy node</text><rect fill="#ADD8E6" filter="url(#fr24uo5v3f154)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="419" x="34" y="620.6455"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="399" x="44" y="641.7842">The machine controller provider deletes the unhealthy instance</text><rect fill="#ADD8E6" filter="url(#fr24uo5v3f154)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="420" x="33.5" y="674.6143"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="400" x="43.5" y="695.7529">The machine controller removes the unhealthy machine finalizer</text><rect fill="#ADD8E6" filter="url(#fr24uo5v3f154)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="374" x="56.5" y="728.583"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="354" x="66.5" y="749.7217">The API server removes the unhealthy machine resource</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="243.5" x2="243.5" y1="30" y2="50"/><polygon fill="#A80036" points="239.5,40,243.5,50,247.5,40,243.5,44" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="243.5" x2="243.5" y1="225.9375" y2="245.9375"/><polygon fill="#A80036" points="239.5,235.9375,243.5,245.9375,247.5,235.9375,243.5,239.9375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="243.5" x2="243.5" y1="279.9063" y2="299.9063"/><polygon fill="#A80036" points="239.5,289.9063,243.5,299.9063,247.5,289.9063,243.5,293.9063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="243.5" x2="243.5" y1="171.9688" y2="191.9688"/><polygon fill="#A80036" points="239.5,181.9688,243.5,191.9688,247.5,181.9688,243.5,185.9688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="353.5" x2="477.5" y1="365.875" y2="365.875"/><polygon fill="#A80036" points="473.5,272.9219,477.5,262.9219,481.5,272.9219,477.5,268.9219" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="477.5" x2="477.5" y1="159.9688" y2="365.875"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="477.5" x2="255.5" y1="159.9688" y2="159.9688"/><polygon fill="#A80036" points="265.5,155.9688,255.5,159.9688,265.5,163.9688,261.5,159.9688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="243.5" x2="243.5" y1="333.875" y2="353.875"/><polygon fill="#A80036" points="239.5,343.875,243.5,353.875,247.5,343.875,243.5,347.875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="243.5" x2="243.5" y1="127.9688" y2="147.9688"/><polygon fill="#A80036" points="239.5,137.9688,243.5,147.9688,247.5,137.9688,243.5,141.9688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="467" x2="501.5" y1="431.3716" y2="431.3716"/><polygon fill="#A80036" points="497.5,272.9219,501.5,262.9219,505.5,272.9219,501.5,268.9219" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="501.5" x2="501.5" y1="115.9688" y2="431.3716"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="501.5" x2="255.5" y1="115.9688" y2="115.9688"/><polygon fill="#A80036" points="265.5,111.9688,255.5,115.9688,265.5,119.9688,261.5,115.9688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="243.5" x2="243.5" y1="377.875" y2="419.3716"/><polygon fill="#A80036" points="239.5,409.3716,243.5,419.3716,247.5,409.3716,243.5,413.3716" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="14" x="247.5" y="399.1797">no</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="243.5" x2="243.5" y1="83.9688" y2="103.9688"/><polygon fill="#A80036" points="239.5,93.9688,243.5,103.9688,247.5,93.9688,243.5,97.9688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.5; stroke-dasharray: 7.0,7.0;" x1="243.5" x2="243.5" y1="443.3716" y2="484.7705"/><polygon fill="#0000FF" points="239.5,474.7705,243.5,484.7705,247.5,474.7705,243.5,478.7705" style="stroke: #0000FF; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="67" x="247.5" y="464.6763">Out of band</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="243.5" x2="243.5" y1="546.6768" y2="566.6768"/><polygon fill="#A80036" points="239.5,556.6768,243.5,566.6768,247.5,556.6768,243.5,560.6768" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="243.5" x2="243.5" y1="600.6455" y2="620.6455"/><polygon fill="#A80036" points="239.5,610.6455,243.5,620.6455,247.5,610.6455,243.5,614.6455" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="243.5" x2="243.5" y1="654.6143" y2="674.6143"/><polygon fill="#A80036" points="239.5,664.6143,243.5,674.6143,247.5,664.6143,243.5,668.6143" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="243.5" x2="243.5" y1="708.583" y2="728.583"/><polygon fill="#A80036" points="239.5,718.583,243.5,728.583,247.5,718.583,243.5,722.583" style="stroke: #A80036; stroke-width: 1.0;"/><!--MD5=[ea701fd5f451e53e8018b1e881bdd15d]
@startuml
start;
:Machine Health Check controller;
repeat
  repeat
    :Watch MHCs;
    :Filter out targets with disabled health-checking;
    :Find unhealthy targets: Need remediation or going towards timeout;
  repeat while (unhealthyTargets > maxUnhealthy) is (yes)
  -> no;
repeat while (API server machine deletion requests for machines that need remediation) is (requeue with minTime to timeout delay)

-[#blue,dashed]-> Out of band;
#LightBlue:The machine owner controller watches deletion timestamp.
Reconciles towards desired number of replicas.
The process to create a new machine/node starts;
#LightBlue:The machine controller drains the unhealthy node;
#LightBlue:The machine controller provider deletes the unhealthy instance;
#LightBlue:The machine controller removes the unhealthy machine finalizer;
#LightBlue:The API server removes the unhealthy machine resource;
@enduml

PlantUML version 1.2019.12(Sun Nov 03 10:24:54 UTC 2019)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.7.0_25-b15
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>